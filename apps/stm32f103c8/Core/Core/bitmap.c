#include "bitmap.h"

void bitmap_init(bitmap_t *bitmap) { bitmap->bitmap = 0; }
void bitmap_set(bitmap_t *bitmap, const uint32_t pos) { bitmap->bitmap |= (1 << pos); }
void bitmap_clear(bitmap_t *bitmap, const uint32_t pos) { bitmap->bitmap &= ~(1 << pos); }
uint32_t bitmapPosCount(void) { return sizeof(bitmap_t) * 8; }
//uint32_t bitmapPosCount(void) { return 32; }

uint32_t bitmap_getFirstSet(bitmap_t *bitmap)
{
    static const uint8_t quickFindTable[256] = {
        /* 00 */ 0xff, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* 10 */ 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* 20 */ 5, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* 30 */ 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* 40 */ 6, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* 50 */ 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* 60 */ 5, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* 70 */ 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* 80 */ 7, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* 90 */ 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* A0 */ 5, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* B0 */ 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* C0 */ 6, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* D0 */ 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* E0 */ 5, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
        /* F0 */ 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0
    };
    if (bitmap->bitmap & 0xff)
        return quickFindTable[(bitmap->bitmap) & 0xff];
    else if (bitmap->bitmap & 0xff00)
        return 8 + quickFindTable[(bitmap->bitmap >> 8) & 0xff];
    else if (bitmap->bitmap & 0xff0000)
        return 16 + quickFindTable[(bitmap->bitmap >> 16) & 0xff] ;
    else if (bitmap->bitmap & 0xff000000)
        return 24 + quickFindTable[(bitmap->bitmap >> 24) & 0xff] ;
    else
        return bitmapPosCount();
}
